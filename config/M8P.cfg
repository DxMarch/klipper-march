##################################
# Motors
##################################
#[endstop_phase]
# Not sure how usefull, 
# Usefull for z if fixed endstop
# klipper3d.org/Endstop_Phase.html

# Motor1
[stepper_z]
step_pin: PE2
dir_pin: !PB4
enable_pin: !PC11
microsteps: 16
rotation_distance: 4
endstop_pin: ^PC0 #probe:z_virtual_endstop
position_endstop: 3
position_min: -0.2
position_max: 260
homing_speed: 8
second_homing_speed: 2
homing_retract_dist: 3

[tmc2209 stepper_z]
uart_pin: PC10
run_current: 1.000
stealthchop_threshold: 999999

# Motor7
[stepper_z1]
step_pin: PD11
dir_pin: PD9
enable_pin: !PD15
microsteps: 16
rotation_distance: 4

[tmc2209 stepper_z1]
uart_pin: PD14
run_current: 0.800
stealthchop_threshold: 999999

# Motor8
[stepper_z2]
step_pin: PD8
dir_pin: PC6
enable_pin: !PC7
microsteps: 16
rotation_distance: 4

[tmc2209 stepper_z2]
uart_pin: PD10
run_current: 0.800
stealthchop_threshold: 999999

# Motor4
[stepper_y]
step_pin: PD3
dir_pin: !PD2
enable_pin: !PD5
microsteps: 32
rotation_distance: 36.55
endstop_pin: ^!PF5
position_endstop: 289 #131
position_min: 0 #-180
position_max: 289 #131
homing_speed: 60
homing_retract_dist: 5
second_homing_speed: 8

[tmc2209 stepper_y]
uart_pin: PD4
run_current: 0.800
stealthchop_threshold: 999999

# Motor2
[stepper_y1]
step_pin: PF12
dir_pin: PF11
enable_pin: !PB3 
microsteps: 32
rotation_distance: 36.55
#endstop_pin: ^!PF4

[tmc2209 stepper_y1]
uart_pin: PF13
run_current: 0.800
stealthchop_threshold: 999999

# Motor3
[stepper_x]
step_pin: PD7
dir_pin: !PD6
enable_pin: !PF10
microsteps: 32
rotation_distance: 40
endstop_pin: ^EBB0: PB5
position_endstop: -5
position_min: -5
position_max: 292
homing_speed: 60
homing_retract_dist: 5
second_homing_speed: 10

[tmc2209 stepper_x]
uart_pin: PF9
run_current: 0.800
stealthchop_threshold: 999999

# Motor5
[dual_carriage]
axis: x
step_pin: PC9
dir_pin: PC8
enable_pin: !PD1
microsteps: 32
rotation_distance: 40
endstop_pin: ^EBB1: PB5
position_endstop: 350
position_min: 60
position_max: 350
homing_speed: 60
homing_retract_dist: 5
second_homing_speed: 10
safe_distance: 50

[tmc2209 dual_carriage]
uart_pin: PD0
run_current: 0.800
stealthchop_threshold: 999999

# Motor6
# [stepper_z1]
# step_pin: PA10
# dir_pin: PA14
# enable_pin: !PA15 
# microsteps: 1
# rotation_distance: 4

# [tmc2209 stepper_z1]
# uart_pin: PF8 
# run_current: 0.800
# #stealthchop_threshold: 999999

######################################
# Bed
######################################

[heater_bed]
heater_pin: PB7
sensor_pin: PA1 # TB 
sensor_type: Generic 3950 #NTC 100K MGB18-104F39050L32
min_temp: 0
max_temp: 100
control: pid
pid_Kp: 54.040
pid_Ki: 2.402
pid_Kd: 303.976

######################################
# Fans
######################################
# Roborock config
[fan_generic CPAP0]
pin: PB9 
max_power: 0.7 # Nidec fan is not made to be run at 24 V.
cycle_time: 0.000037
#   The amount of time (in seconds) for each PWM power cycle to the
#   fan. It is recommended this be 10 milliseconds or greater when
#   using software based PWM. The default is 0.010 seconds.
hardware_pwm: True
#   Enable this to use hardware PWM instead of software PWM. Most fans
#   do not work well with hardware PWM, so it is not recommended to
#   enable this unless there is an electrical requirement to switch at
#   very high speeds. When using hardware PWM the actual cycle time is
#   constrained by the implementation and may be significantly
#   different than the requested cycle_time. The default is False.
off_below: 0.3
#   The minimum input speed which will power the fan (expressed as a
#   value from 0.0 to 1.0). When a speed lower than off_below is
#   requested the fan will instead be turned off. This setting may be
#   used to prevent fan stalls and to ensure kick starts are
#   effective. The default is 0.0.
#
#   This setting should be recalibrated whenever max_power is adjusted.
#   To calibrate this setting, start with off_below set to 0.0 and the
#   fan spinning. Gradually lower the fan speed to determine the lowest
#   input speed which reliably drives the fan without stalls. Set
#   off_below to the duty cycle corresponding to this value (for
#   example, 12% -> 0.12) or slightly higher.
tachometer_pin: PC15
#   Tachometer input pin for monitoring fan speed. A pullup is generally
#   required. This parameter is optional.
tachometer_ppr: 4
#   When tachometer_pin is specified, this is the number of pulses per
#   revolution of the tachometer signal. For a BLDC fan this is
#   normally half the number of poles. The default is 2.
tachometer_poll_interval: 0.0001
#   When tachometer_pin is specified, this is the polling period of the
#   tachometer pin, in seconds. The default is 0.0015, which is fast
#   enough for fans below 10000 RPM at 2 PPR. This must be smaller than
#   30/(tachometer_ppr*rpm), with some margin, where rpm is the
#   maximum speed (in RPM) of the fan.

[fan_generic CPAP1]
pin: PB8
max_power: 0.7 # Nidec fan is not made to be run at 24 V.
cycle_time: 0.000037
hardware_pwm: True
off_below: 0.3
tachometer_pin: PC14
tachometer_ppr: 4
tachometer_poll_interval: 0.0001

# Fan1
# [controller_fan MCU_fan1]
# pin: PE0
#MCU Fan

[temperature_fan Mainboard]
pin: PE1
sensor_type: temperature_mcu
max_power: 1.0
shutdown_speed: 1.0
hardware_pwm: false
kick_start_time: 0.5
off_below: 0.99
max_temp: 100
min_temp: 5
target_temp: 60
max_speed: 1.0
min_speed: 0.3
control: pid
pid_Kp: 1
pid_Ki: 1
pid_Kd: 1

#########################################
# Printer
#########################################

[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_2F004C0011504B4633373520-if00
#serial: /dev/serial/by-id/*
#serial: /dev/ttyACM0 restart_method: command
canbus_uuid: 00b8fb30d8bc

# Not used when we have MCU Fan
# [temperature_sensor M8P_temp]
# sensor_type: temperature_mcu

[temperature_sensor CB1_temp]
sensor_type: temperature_host

[temperature_sensor chamber]
sensor_type: PT1000
sensor_pin: PA0
min_temp: 0
max_temp: 100
gcode_id: C

# LED Strip
#[led printer_light]
#red_pin: PE6
[output_pin printer_light]
pin: PE6   # Replace with your actual pin
pwm: False # Set to False for on/off control

[output_pin offset_light]
pin: PE5
pwm: False

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE9, EXP1_2=PE10,
    EXP1_3=PE11, EXP1_4=PE12,
    EXP1_5=PE13, EXP1_6=PE14,    # Slot in the socket on this side
    EXP1_7=PE15, EXP1_8=PB10,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PB14, EXP2_2=PB13,
    EXP2_3=PF7, EXP2_4=PB12,
    EXP2_5=PE7, EXP2_6=PB11,      # Slot in the socket on this side
    EXP2_7=PE8, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5

